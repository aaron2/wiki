file delete wiki.db

set argv none
source initialize_db
wiki
fts
source wiki.cgi

if {[db onecolumn {select count(id) from nodes}] > 0} { error }

set request(USER_LEVEL) {4 {nc wc}}
settings
set settings(FILTER_HTML) 0

proc add_file {file} {
    set fh [open $file r]
    set content [read $fh]
    close $fh

    db eval {insert into nodes (name,content,level) values($file,$content,'X0113')}
    set id [db last_insert_rowid]
    set parsed [parse_static $id $content]
    set strip "$file [striphtml $parsed]"

    db eval {update nodes set parsed=$parsed,modified=datetime('now'),created=datetime('now') where id=$id}
    fts eval {insert into search (id,name,level,content) values($id,$file,'X0113',$strip)}
}

cd default
foreach file [lsort [glob *]] {
    #puts "add $file"
    add_file $file
}
